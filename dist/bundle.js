!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Undo=t():e.Undo=t()}(self,(()=>(()=>{var e={571:function(e,t){var n,r;n=function(e){"use strict";var t=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),n=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.target=t,this.isContentEditable=t&&t.contentEditable}return t(e,[{key:"getPos",value:function(){if(document.activeElement!==this.target)return-1;if(this.isContentEditable){this.target.focus();var e=document.getSelection().getRangeAt(0),t=e.cloneRange();return t.selectNodeContents(this.target),t.setEnd(e.endContainer,e.endOffset),t.toString().length}return this.target.selectionStart}},{key:"setPos",value:function(e){if(this.isContentEditable){if(e>=0){var t=window.getSelection(),n=this.createRange(this.target,{count:e});n&&(n.collapse(!1),t.removeAllRanges(),t.addRange(n))}}else this.target.setSelectionRange(e,e)}},{key:"createRange",value:function(e,t,n){if(n||((n=document.createRange()).selectNode(e),n.setStart(e,0)),0===t.count)n.setEnd(e,t.count);else if(e&&t.count>0)if(e.nodeType===Node.TEXT_NODE)e.textContent.length<t.count?t.count-=e.textContent.length:(n.setEnd(e,t.count),t.count=0);else for(var r=0;r<e.childNodes.length&&(n=this.createRange(e.childNodes[r],t,n),0!==t.count);r++);return n}}]),e}();e.exports=n},void 0===(r=n.apply(t,[e]))||(e.exports=r)},334:(e,t,n)=>{e.exports=n(571)}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var r={};return(()=>{"use strict";n.d(r,{default:()=>d});var e=n(334),t=n.n(e);function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.holder=n,this.observer=null,this.debounceTimer=r,this.mutationDebouncer=this.debounce((function(){t()}),this.debounceTimer)}var t,n;return t=e,n=[{key:"setMutationObserver",value:function(){var e=this,t=this.holder.querySelector(".codex-editor__redactor");this.observer=new MutationObserver((function(t){e.mutationHandler(t)})),this.observer.observe(t,{childList:!0,attributes:!0,subtree:!0,characterData:!0,characterDataOldValue:!0})}},{key:"mutationHandler",value:function(e){var t=this,n=!1;e.forEach((function(e){switch(e.type){case"childList":e.target===t.holder?t.onDestroy():n=!0;break;case"characterData":n=!0;break;case"attributes":e.target.classList.contains("ce-block")||e.target.classList.contains("tc-toolbox")||(n=!0)}})),n&&this.mutationDebouncer()}},{key:"debounce",value:function(e,t){var n,r=this;return function(){for(var i=arguments.length,o=new Array(i),s=0;s<i;s++)o[s]=arguments[s];var a=r;clearTimeout(n),n=setTimeout((function(){return e.apply(a,o)}),t)}}},{key:"onDestroy",value:function(){var e=new CustomEvent("destroy");document.dispatchEvent(e),this.observer.disconnect()}}],n&&i(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();function s(e,t,n,r,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function a(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){s(o,r,i,a,c,"next",e)}function c(e){s(o,r,i,a,c,"throw",e)}a(void 0)}))}}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var d=function(){function e(t){var n=this,r=t.editor,i=t.config,s=void 0===i?{}:i,a=t.onUpdate,c=t.maxLength;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var l={maxLength:30,onUpdate:function(){},config:{debounceTimer:200,shortcuts:{undo:["CMD+Z"],redo:["CMD+Y","CMD+SHIFT+Z"]}}},h=r.blocks,d=r.caret,f=r.configuration,p=f.holder,k=f.defaultBlock,b=l.config.shortcuts,v=s.shortcuts,y=u(u({},b),v),g=Array.isArray(y.undo)?y.undo:[y.undo],x=Array.isArray(y.redo)?y.redo:[y.redo],m=l.config.debounceTimer,w=s.debounceTimer,O=void 0===w?m:w;this.holder="string"==typeof p?document.getElementById(p):p,this.editor=r,this.defaultBlock=k,this.blocks=h,this.caret=d,this.shouldSaveHistory=!0,this.readOnly=f.readOnly,this.maxLength=c||l.maxLength,this.onUpdate=a||l.onUpdate,this.config={debounceTimer:O,shortcuts:{undo:g,redo:x}},new o((function(){return n.registerChange()}),this.holder,this.config.debounceTimer).setMutationObserver(),this.setEventListeners(),this.initialItem=null,this.clear()}var n,r,i,s,c,l;return n=e,r=[{key:"truncate",value:function(e,t){for(;e.length>t;)e.shift()}},{key:"initialize",value:function(e){var t="blocks"in e?e.blocks:e,n={index:t.length-1,state:t};this.stack[0]=n,this.initialItem=n}},{key:"clear",value:function(){this.stack=this.initialItem?[this.initialItem]:[{index:0,state:[{type:this.defaultBlock,data:{}}]}],this.position=0,this.onUpdate()}},{key:"setReadOnly",value:function(){var e=this.holder.querySelector(".ce-toolbox");this.readOnly=!e}},{key:"registerChange",value:function(){var e=this;this.setReadOnly(),this.readOnly||(this.editor&&this.editor.save&&this.shouldSaveHistory&&this.editor.save().then((function(t){e.editorDidUpdate(t.blocks)&&e.save(t.blocks)})),this.shouldSaveHistory=!0)}},{key:"editorDidUpdate",value:function(e){var t=this.stack[this.position].state;return!!e.length&&(e.length!==t.length||JSON.stringify(t)!==JSON.stringify(e))}},{key:"save",value:function(e){this.position>=this.maxLength&&this.truncate(this.stack,this.maxLength),this.position=Math.min(this.position,this.stack.length-1),this.stack=this.stack.slice(0,this.position+1);var t=this.blocks.getCurrentBlockIndex(),n=this.blocks.getBlocksCount(),r=t;e[t]||(r-=n-e.length);var i=!e[r]||"paragraph"!==e[r].type&&"header"!==e[r].type?null:this.getCaretIndex(t);this.stack.push({index:r,state:e,caretIndex:i}),this.position+=1,this.onUpdate()}},{key:"getCaretIndex",value:function(e){var n=this.holder.getElementsByClassName("ce-block__content");return new(t())(n[e].firstChild).getPos()}},{key:"insertDeletedBlock",value:function(e,t,n){for(var r=0;r<e.length;r+=1)if(!t[r]||e[r].id!==t[r].id){this.blocks.insert(e[r].type,e[r].data,{},r,!0),this.caret.setToBlock(n,"end");break}}},{key:"blockWasDropped",value:function(e,t){return e.length===t.length&&e.some((function(e,n){return e.id!==t[n].id}))}},{key:"blockWasSkipped",value:function(e,t,n,r){return e<t&&n.length!==r.length}},{key:"contentChangedInNoFocusBlock",value:function(e,t){return e!==t}},{key:"blockWasDeleted",value:function(e,t){return e.length>t.length}},{key:"undo",value:(l=a(regeneratorRuntime.mark((function e(){var t,n,r,i,o,s,a,c,u,l,h,d=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.canUndo()){e.next=39;break}if(t=this.stack[this.position],n=t.index,r=t.state,this.position-=1,this.shouldSaveHistory=!1,i=this.stack[this.position].index,o=this.stack[this.position],s=o.state,a=o.caretIndex,this.onUpdate(),c=this.blocks.getBlocksCount(),s[i]||(i-=1,this.stack[this.position].index=i),!this.blockWasDeleted(s,r)){e.next=13;break}this.insertDeletedBlock(s,r,i),e.next=34;break;case 13:if(!this.blockWasSkipped(i,n,s,r)){e.next=19;break}return e.next=16,this.blocks.delete(n);case 16:this.caret.setToBlock(i,"end"),e.next=34;break;case 19:if(!(c>s.length)){e.next=24;break}return e.next=22,this.blocks.render({blocks:s}).then((function(){d.editor.blocks.insert(d.defaultBlock,{}),d.setCaretIndex(i,a)}));case 22:e.next=34;break;case 24:if(!this.blockWasDropped(s,r)){e.next=29;break}return e.next=27,this.blocks.render({blocks:s}).then((function(){return d.caret.setToBlock(i,"end")}));case 27:e.next=34;break;case 29:if(!this.contentChangedInNoFocusBlock(i,n)){e.next=34;break}return u=this.blocks.getBlockByIndex(n),l=u.id,e.next=33,this.blocks.update(l,s[n].data);case 33:this.setCaretIndex(i,a);case 34:if(!(h=this.blocks.getBlockByIndex(i))){e.next=39;break}return e.next=38,this.blocks.update(h.id,s[i].data);case 38:this.setCaretIndex(i,a);case 39:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"setCaretIndex",value:function(e,n){if(n&&-1!==n){var r=this.holder.getElementsByClassName("ce-block__content"),i=new(t())(r[e].firstChild);setTimeout((function(){return i.setPos(n)}),50)}else this.caret.setToBlock(e,"end")}},{key:"insertBlock",value:(c=a(regeneratorRuntime.mark((function e(t,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.blocks.insert(t[n].type,t[n].data,{},n,!0);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"insertSkippedBlocks",value:function(e,t){for(var n=e;n<t.length;n+=1)this.insertBlock(t,n)}},{key:"redo",value:(s=a(regeneratorRuntime.mark((function e(){var t,n,r,i,o,s,a,c,u=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.canRedo()){e.next=25;break}if(this.position+=1,this.shouldSaveHistory=!1,t=this.stack[this.position],n=t.index,r=t.state,i=t.caretIndex,o=this.stack[this.position-1],s=o.index,a=o.state,!this.blockWasDeleted(a,r)){e.next=11;break}return e.next=8,this.blocks.delete();case 8:this.caret.setToBlock(n,"end"),e.next=19;break;case 11:if(!this.blockWasSkipped(s,n,r,a)){e.next=16;break}this.insertSkippedBlocks(a.length,r),this.caret.setToBlock(n,"end"),e.next=19;break;case 16:if(!this.blockWasDropped(r,a)||1===this.position){e.next=19;break}return e.next=19,this.blocks.render({blocks:r}).then((function(){return u.caret.setToBlock(n,"end")}));case 19:if(this.onUpdate(),!(c=this.blocks.getBlockByIndex(n))){e.next=25;break}return e.next=24,this.blocks.update(c.id,r[n].data);case 24:this.setCaretIndex(n,i);case 25:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"canUndo",value:function(){return!this.readOnly&&this.position>0}},{key:"canRedo",value:function(){return!this.readOnly&&this.position<this.count()}},{key:"count",value:function(){return this.stack.length-1}},{key:"parseKeys",value:function(e){var t={CMD:/(Mac)/i.test(navigator.platform)?"metaKey":"ctrlKey",ALT:"altKey",SHIFT:"shiftKey"},n=e.slice(0,-1).map((function(e){return t[e]})),r=n.includes("shiftKey")&&2===e.length?e[e.length-1].toUpperCase():e[e.length-1].toLowerCase();return n.push(r),n}},{key:"setEventListeners",value:function(){var e=this,t=this.holder,n=this.config.shortcuts,r=n.undo,i=n.redo,o=r.map((function(e){return e.replace(/ /g,"").split("+")})),s=i.map((function(e){return e.replace(/ /g,"").split("+")})),a=o.map((function(t){return e.parseKeys(t)})),c=s.map((function(t){return e.parseKeys(t)})),u=function(e,t){return t.reduce((function(t,n){return t||function(e,t){return 3===t.length&&e[t[0]]&&e[t[1]]&&e.key.toLowerCase()===t[2]}(e,n)}),!1)},l=function(e,t,n){return!(!function(e,t){return t.reduce((function(t,n){return t||function(e,t){return 2===t.length&&e[t[0]]&&e.key.toLowerCase()===t[1]}(e,n)}),!1)}(e,t)||u(e,n))||!!u(e,t)},h=function(t){l(t,a,c)&&(t.preventDefault(),e.undo())},d=function(t){l(t,c,a)&&(t.preventDefault(),e.redo())};t.addEventListener("keydown",h),t.addEventListener("keydown",d),t.addEventListener("destroy",(function(){t.removeEventListener("keydown",h),t.removeEventListener("keydown",d)}))}}],i=[{key:"isReadOnlySupported",get:function(){return!0}}],r&&h(n.prototype,r),i&&h(n,i),Object.defineProperty(n,"prototype",{writable:!1}),e}()})(),r.default})()));